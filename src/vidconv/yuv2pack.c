#include <re.h>
#include <rem_vid.h>
#include <rem_dsp.h>
#include <rem_vidconv.h>
#include "vconv.h"


#if 0

/*
 * The lookup tables are generated with the following code:
 */

#define P 14

#define COEF_RV ((int32_t) (1.370705f * (float)(1 << P)))
#define COEF_GU ((int32_t) (-0.337633f * (float)(1 << P)))
#define COEF_GV ((int32_t) (-0.698001f * (float)(1 << P)))
#define COEF_BU ((int32_t) (1.732446f * (float)(1 << P)))

#define ERV(a) (COEF_RV * ((a) - 128))
#define EGU(a) (COEF_GU * ((a) - 128))
#define EGV(a) (COEF_GV * ((a) - 128))
#define EBU(a) (COEF_BU * ((a) - 128))


int16_t CRV[256];
int16_t CGU[256];
int16_t CGV[256];
int16_t CBU[256];


static void init_table(void)
{
	int i;

	for (i = 0; i < 256; ++i) {
		CRV[i] = ERV(i) >> P;
		CGU[i] = EGU(i) >> P;
		CGV[i] = EGV(i) >> P;
		CBU[i] = EBU(i) >> P;
	}
}
#endif


static const int16_t CRV[256] = {
	-176,-175,-173,-172,-170,-169,-168,-166,-165,-164,-162,-161,
	-159,-158,-157,-155,-154,-153,-151,-150,-149,-147,-146,-144,
	-143,-142,-140,-139,-138,-136,-135,-133,-132,-131,-129,-128,
	-127,-125,-124,-122,-121,-120,-118,-117,-116,-114,-113,-112,
	-110,-109,-107,-106,-105,-103,-102,-101, -99, -98, -96, -95,
	 -94, -92, -91, -90, -88, -87, -85, -84, -83, -81, -80, -79,
	 -77, -76, -75, -73, -72, -70, -69, -68, -66, -65, -64, -62,
	 -61, -59, -58, -57, -55, -54, -53, -51, -50, -48, -47, -46,
	 -44, -43, -42, -40, -39, -38, -36, -35, -33, -32, -31, -29,
	 -28, -27, -25, -24, -22, -21, -20, -18, -17, -16, -14, -13,
	 -11, -10,  -9,  -7,  -6,  -5,  -3,  -2,   0,   1,   2,   4,
	   5,   6,   8,   9,  10,  12,  13,  15,  16,  17,  19,  20,
	  21,  23,  24,  26,  27,  28,  30,  31,  32,  34,  35,  37,
	  38,  39,  41,  42,  43,  45,  46,  47,  49,  50,  52,  53,
	  54,  56,  57,  58,  60,  61,  63,  64,  65,  67,  68,  69,
	  71,  72,  74,  75,  76,  78,  79,  80,  82,  83,  84,  86,
	  87,  89,  90,  91,  93,  94,  95,  97,  98, 100, 101, 102,
	 104, 105, 106, 108, 109, 111, 112, 113, 115, 116, 117, 119,
	 120, 121, 123, 124, 126, 127, 128, 130, 131, 132, 134, 135,
	 137, 138, 139, 141, 142, 143, 145, 146, 148, 149, 150, 152,
	 153, 154, 156, 157, 158, 160, 161, 163, 164, 165, 167, 168,
	 169, 171, 172, 174};

static const int16_t CGU[256] = {
	  43,  42,  42,  42,  41,  41,  41,  40,  40,  40,  39,  39,
	  39,  38,  38,  38,  37,  37,  37,  36,  36,  36,  35,  35,
	  35,  34,  34,  34,  33,  33,  33,  32,  32,  32,  31,  31,
	  31,  30,  30,  30,  29,  29,  29,  28,  28,  28,  27,  27,
	  27,  26,  26,  25,  25,  25,  24,  24,  24,  23,  23,  23,
	  22,  22,  22,  21,  21,  21,  20,  20,  20,  19,  19,  19,
	  18,  18,  18,  17,  17,  17,  16,  16,  16,  15,  15,  15,
	  14,  14,  14,  13,  13,  13,  12,  12,  12,  11,  11,  11,
	  10,  10,  10,   9,   9,   9,   8,   8,   8,   7,   7,   7,
	   6,   6,   6,   5,   5,   5,   4,   4,   4,   3,   3,   3,
	   2,   2,   2,   1,   1,   1,   0,   0,   0,  -1,  -1,  -2,
	  -2,  -2,  -3,  -3,  -3,  -4,  -4,  -4,  -5,  -5,  -5,  -6,
	  -6,  -6,  -7,  -7,  -7,  -8,  -8,  -8,  -9,  -9,  -9, -10,
	 -10, -10, -11, -11, -11, -12, -12, -12, -13, -13, -13, -14,
	 -14, -14, -15, -15, -15, -16, -16, -16, -17, -17, -17, -18,
	 -18, -18, -19, -19, -19, -20, -20, -20, -21, -21, -21, -22,
	 -22, -22, -23, -23, -23, -24, -24, -24, -25, -25, -25, -26,
	 -26, -26, -27, -27, -28, -28, -28, -29, -29, -29, -30, -30,
	 -30, -31, -31, -31, -32, -32, -32, -33, -33, -33, -34, -34,
	 -34, -35, -35, -35, -36, -36, -36, -37, -37, -37, -38, -38,
	 -38, -39, -39, -39, -40, -40, -40, -41, -41, -41, -42, -42,
	 -42, -43, -43, -43};

static const int16_t CGV[256] = {
	  89,  88,  87,  87,  86,  85,  85,  84,  83,  83,  82,  81,
	  80,  80,  79,  78,  78,  77,  76,  76,  75,  74,  73,  73,
	  72,  71,  71,  70,  69,  69,  68,  67,  67,  66,  65,  64,
	  64,  63,  62,  62,  61,  60,  60,  59,  58,  57,  57,  56,
	  55,  55,  54,  53,  53,  52,  51,  50,  50,  49,  48,  48,
	  47,  46,  46,  45,  44,  43,  43,  42,  41,  41,  40,  39,
	  39,  38,  37,  36,  36,  35,  34,  34,  33,  32,  32,  31,
	  30,  30,  29,  28,  27,  27,  26,  25,  25,  24,  23,  23,
	  22,  21,  20,  20,  19,  18,  18,  17,  16,  16,  15,  14,
	  13,  13,  12,  11,  11,  10,   9,   9,   8,   7,   6,   6,
	   5,   4,   4,   3,   2,   2,   1,   0,   0,  -1,  -2,  -3,
	  -3,  -4,  -5,  -5,  -6,  -7,  -7,  -8,  -9, -10, -10, -11,
	 -12, -12, -13, -14, -14, -15, -16, -17, -17, -18, -19, -19,
	 -20, -21, -21, -22, -23, -24, -24, -25, -26, -26, -27, -28,
	 -28, -29, -30, -31, -31, -32, -33, -33, -34, -35, -35, -36,
	 -37, -37, -38, -39, -40, -40, -41, -42, -42, -43, -44, -44,
	 -45, -46, -47, -47, -48, -49, -49, -50, -51, -51, -52, -53,
	 -54, -54, -55, -56, -56, -57, -58, -58, -59, -60, -61, -61,
	 -62, -63, -63, -64, -65, -65, -66, -67, -68, -68, -69, -70,
	 -70, -71, -72, -72, -73, -74, -74, -75, -76, -77, -77, -78,
	 -79, -79, -80, -81, -81, -82, -83, -84, -84, -85, -86, -86,
	 -87, -88, -88, -89};

static const int16_t CBU[256] = {
	-222,-221,-219,-217,-215,-214,-212,-210,-208,-207,-205,-203,
	-201,-200,-198,-196,-195,-193,-191,-189,-188,-186,-184,-182,
	-181,-179,-177,-175,-174,-172,-170,-169,-167,-165,-163,-162,
	-160,-158,-156,-155,-153,-151,-149,-148,-146,-144,-143,-141,
	-139,-137,-136,-134,-132,-130,-129,-127,-125,-124,-122,-120,
	-118,-117,-115,-113,-111,-110,-108,-106,-104,-103,-101, -99,
	 -98, -96, -94, -92, -91, -89, -87, -85, -84, -82, -80, -78,
	 -77, -75, -73, -72, -70, -68, -66, -65, -63, -61, -59, -58,
	 -56, -54, -52, -51, -49, -47, -46, -44, -42, -40, -39, -37,
	 -35, -33, -32, -30, -28, -26, -25, -23, -21, -20, -18, -16,
	 -14, -13, -11,  -9,  -7,  -6,  -4,  -2,   0,   1,   3,   5,
	   6,   8,  10,  12,  13,  15,  17,  19,  20,  22,  24,  25,
	  27,  29,  31,  32,  34,  36,  38,  39,  41,  43,  45,  46,
	  48,  50,  51,  53,  55,  57,  58,  60,  62,  64,  65,  67,
	  69,  71,  72,  74,  76,  77,  79,  81,  83,  84,  86,  88,
	  90,  91,  93,  95,  97,  98, 100, 102, 103, 105, 107, 109,
	 110, 112, 114, 116, 117, 119, 121, 123, 124, 126, 128, 129,
	 131, 133, 135, 136, 138, 140, 142, 143, 145, 147, 148, 150,
	 152, 154, 155, 157, 159, 161, 162, 164, 166, 168, 169, 171,
	 173, 174, 176, 178, 180, 181, 183, 185, 187, 188, 190, 192,
	 194, 195, 197, 199, 200, 202, 204, 206, 207, 209, 211, 213,
	 214, 216, 218, 220};


static inline void yuv2rgb(uint8_t *rgb, uint8_t y, int ruv, int guv, int buv)
{
	*rgb++ = saturate_u8(y + buv);
	*rgb++ = saturate_u8(y + guv);
	*rgb++ = saturate_u8(y + ruv);
	*rgb++ = 0;
}


/* native endian */
static inline void yuv2rgb565(uint8_t *rgb, uint8_t y,
			      int ruv, int guv, int buv)
{
	uint16_t *p = (uint16_t *)rgb;

	*p  = (saturate_u8(y + ruv) & 0xf8) << 8;
	*p |= (saturate_u8(y + guv) & 0xfc) << 3;
	*p |=  saturate_u8(y + buv) >> 3;
}


/**
 * Convert from Planar YUV420P to generic Packed format
 */
void vidconv_yuv420p_to_packed(struct vidframe *dst,
			       const struct vidframe *src, int flags)
{
	const uint8_t *y0 = src->data[0];
	const uint8_t *y1 = src->data[0] + src->linesize[0];
	const uint8_t *u = src->data[1], *v = src->data[2];
	uint8_t *p0, *p1;
	int px, h, w;

	/* vertical flip -- read source in opposite direction */
	if (flags & VIDCONV_VFLIP) {
		p0 = (dst->data[0] + dst->linesize[0] * (dst->size.h - 1));
		p1 = (dst->data[0] + dst->linesize[0] * (dst->size.h - 2));
		px = -dst->linesize[0] * 2;
	}
	else {
		p0 = dst->data[0];
		p1 = dst->data[0] + dst->linesize[0];
		px = dst->linesize[0] * 2;
	}

	/* 2 lines */
	for (h=0; h<dst->size.h/2; h++) {

		int _u, _v;
		int ruv, guv, buv;

		int pw = 0;

		/* 2 pixels */
		for (w=0; w<dst->size.w/2; w++) {

			switch (dst->fmt) {

			case VID_FMT_ARGB:
			case VID_FMT_RGB32:

				_u = u[w];
				_v = v[w];

				ruv = CRV[_v];
				guv = CGV[_v] + CGU[_u];
				buv = CBU[_u];

				yuv2rgb(&p0[pw + 0], y0[2*w], ruv, guv, buv);
				yuv2rgb(&p0[pw + 4], y0[2*w+1], ruv, guv, buv);
				yuv2rgb(&p1[pw + 0], y1[2*w], ruv, guv, buv);
				yuv2rgb(&p1[pw + 4], y1[2*w+1], ruv, guv, buv);

				pw += 8; /* STEP */
				break;

			case VID_FMT_RGB565:

				_u = u[w];
				_v = v[w];

				ruv = CRV[_v];
				guv = CGV[_v] + CGU[_u];
				buv = CBU[_u];

				yuv2rgb565(&p0[pw+0], y0[2*w], ruv, guv, buv);
				yuv2rgb565(&p0[pw+2], y0[2*w+1],ruv, guv, buv);
				yuv2rgb565(&p1[pw+0], y1[2*w], ruv, guv, buv);
				yuv2rgb565(&p1[pw+2], y1[2*w+1],ruv, guv, buv);

				pw += 4; /* STEP */
				break;

			default:
				re_printf("yuv2pack: no fmt %d\n", dst->fmt);
				return;
			}
		}

		y0 += (src->linesize[0] * 2);
		y1 += (src->linesize[0] * 2);
		u  += src->linesize[1];
		v  += src->linesize[2];
		p0 += px;
		p1 += px;
	}
}
